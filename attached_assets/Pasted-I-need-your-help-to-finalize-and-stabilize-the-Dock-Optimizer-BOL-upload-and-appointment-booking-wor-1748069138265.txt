I need your help to finalize and stabilize the Dock Optimizer BOL upload and appointment booking workflow. This prompt addresses multiple coordinated backend and frontend fixes. These are mission-critical. Please move decisively but safely.

---

### OBJECTIVES

You must address all of the following:

#### 1. BOL → APPOINTMENT LINKAGE (High Priority)
- Ensure that uploaded BOLs are **linked to appointments** via the `appointment_bol_links` table.
- This must work whether the BOL is uploaded:
  - Before the appointment is created (pending later linkage)
  - After the appointment is created (direct linkage)

**Requirements**:
- The `scheduleId` must be passed from the frontend to the BOL upload endpoint if an appointment exists.
- In `bolService`, detect and link the uploaded `bol_document` ID to the given `scheduleId`.
- Insert into `appointment_bol_links`: `{ appointment_id, bol_document_id }`.

**Confirmation Page and Admin View**:
- On appointment confirmation page and appointment modal in admin, render:
  - Linked BOL filename (e.g. `bol_...pdf`)
  - File size
  - Direct download link (`/uploads/bol/<filename>`)

#### 2. CONFIRMATION CODE CONSISTENCY (High Priority)
- Fix the mismatch between confirmation code shown on the booking confirmation screen (e.g., `HZL-465564`) and the one shown in the admin appointment modal (e.g., `HC000113`).
- Unify logic to **always use the backend-generated code**.

**Requirements**:
- Move confirmation code generation to backend only.
- Expose it in the `createAppointment` response payload.
- Ensure the frontend confirmation screen displays exactly this value.
- Optional: Prefix with `HZL-` or similar, but use same function across app.

#### 3. BOL DOCUMENT DISPLAY (Visual Consistency)
- Ensure appointment modal always shows linked BOL documents if present.
- If none exist, show a friendly message like “No BOL uploaded yet.”

#### 4. EMAIL CONFIRMATION (Restore Reliability)
- Ensure booking confirmation emails are sent:
  - Immediately after successful appointment creation
  - Include the confirmation code and uploaded BOL document filename if available

**Requirements**:
- Add server logs for all `sendConfirmationEmail()` errors.
- Retry once if email fails transiently.
- Add debug toggle to log raw email content to file for inspection.

#### 5. OCR VALIDATION FEEDBACK (Optional Polish)
- If OCR fails but file is still uploaded, make this clear:
  - Show “OCR failed, but file was saved” in frontend alert
  - Log `ocrSuccess: false` and include diagnostic reason (e.g., “no text detected”)

#### 6. TIMEZONE DISPLAY IN BOOKING UI (Secondary)
- Normalize and display dates in Pacific Time (PDT/PST).
- Ensure date math is consistent between:
  - Admin log view
  - Calendar picker
  - Confirmation screen

---

### CONSTRAINTS
- Do not break multi-tenancy or module toggles (e.g., appointments, calendar, asset manager)
- Maintain existing schema and data unless explicitly instructed
- If a route or handler is missing, create it under `server/routes/bol-upload.mjs` or `bol-ocr.mjs` using ES module syntax
- Log all failures to `server/logger.ts`

---

### FOLLOWUPS I EXPECT FROM YOU
- ✅ A list of all modified files and functions
- ✅ SQL statements executed or schema updates made
- ✅ Confirmation that:
  - BOL links show in both UI layers
  - Confirmation codes match across surfaces
  - Emails are being sent and logged

---

Please start now and execute thoroughly.
