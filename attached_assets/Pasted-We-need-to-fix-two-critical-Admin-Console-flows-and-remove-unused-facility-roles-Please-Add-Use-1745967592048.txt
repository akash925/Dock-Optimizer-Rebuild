We need to fix two critical Admin-Console flows and remove unused “facility” roles. Please:

Add User → Organization

Backend:

In server/modules/admin/routes.ts (or wherever you handle org-user relations), add/repair a POST /api/admin/orgs/:orgId/users endpoint that:

Parses JSON body { userId: number, role: string }.

Inserts or updates organization_users with (organization_id = orgId, user_id = userId, role_id = (SELECT id FROM roles WHERE name = role)).

Returns the full list of users for that org.

Ensure you send res.json({ success: true, users: [...] }) or on failure res.status(500).json({ message: "Failed to update organization user" }).

Frontend:

In client/src/pages/admin/orgs/[id].tsx:

Configure the “Add User” form’s onSubmit to mutate({ orgId, userId, role }) against your new POST route.

Send proper headers:

js
Copy
Edit
headers: { "Content-Type": "application/json" },
body: JSON.stringify({ userId, role })
Invalidate the React-Query cache for the org’s user list so the table refreshes automatically.

Toggle Organization Modules

Backend:

In server/modules/admin/routes.ts, add/repair PUT /api/admin/orgs/:orgId/modules/:moduleName that:

Parses JSON { enabled: boolean }.

Upserts into organization_modules table.

Returns the updated module record or org module list.

Always respond with valid JSON or res.status(500).json({ message: "Failed to update organization module" }).

Frontend:

In client/src/pages/admin/orgs/[id].tsx under the Modules tab:

For each toggle, call your new PUT route with moduleName and { enabled }.

Send Content-Type: application/json and JSON.stringify({ enabled }).

On success, update local state or invalidate the modules query so the UI immediately reflects the change.

Handle JSON parse errors by logging response.text() if response.json() fails.

Remove Facility-Scoped Roles

Backend & Database:

Remove or mark inactive any roles entries named facility_manager or facility_staff.

Ensure your role-seed script no longer includes them.

Frontend:

In every user-or-org role dropdown (e.g. client/src/api/admin.ts and .tsx forms), filter out those two roles so they never appear.

Error Context

Wherever you catch a failure, return a clear JSON error message.

On the frontend, log any network failures and show the full response body in the console so I can diagnose.

After applying these changes, please run through and verify:

Users Tab → “Add User” now sends a valid POST, and the new user appears in the list.

Modules Tab → Toggling fires a PUT, and the switch state persists on reload.

Those two facility roles are gone from every dropdown.

If anything still breaks, capture:

The Network request URL, method, request payload, response code & body.

Any Console error messages.