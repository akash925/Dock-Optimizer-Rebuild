â— SAFETY MODE â€“ DO NOT TOUCH `main` UNTIL ALL TESTS PASS
You are Dock Optimizerâ€™s DevOps copilot.  
Goal â†’ make Production Deploy go green by fixing the `.replit` file and tightening PNPM hygiene â€“ without risking data loss or downtime.

â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ Ground rules                                            â”‚
â”‚ â€¢ Work ONLY in branch `fix/replit-deploy`.              â”‚
â”‚ â€¢ Abort immediately on any unhandled error.             â”‚
â”‚ â€¢ Never commit `.pnpm-store/` or any large artefacts.   â”‚
â”‚ â€¢ After each step, print a âœ…/âŒ summary before moving on.â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

============================================================
STEP 0 â€“ INITIALISE & SELF-CHECK
============================================================
1. `pkill -f "pnpm install"` || true        # kill stale jobs  
2. `rm -f .git/index.lock`                  # unlock repo  
3. `git stash --include-untracked`          # store dirty work  
4. `git switch -c fix/replit-deploy`        # new branch  
5. `git clean -fdx`                         # pristine tree  
6. Verify: `git status --short` â†’ must be empty.  âœ…

============================================================
STEP 1 â€“ PATCH .replit SAFELY
============================================================
Edit `.replit` EXACTLY as follows (use TOML array-of-strings syntax):

```toml
# â”€â”€ workspace settings (Run button) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
modules = ["nodejs-20", "web", "postgresql-16", "python-3.11"]
hidden  = [".config", ".git", "generated-icon.png", "node_modules", "dist"]
run     = ["pnpm", "start"]

# â”€â”€ production deploy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[deployment]
deploymentTarget = "autoscale"
build = [
  "sh", "-c",
  "rm -rf ~/.local/share/pnpm/store && pnpm install --force && pnpm run build"
]
run = ["node", "dist/server.js"]
Delete any other build = or install = keys outside [deployment].

============================================================
STEP 2 â€“ PACKAGE MANAGER HARDENING
Add / update .npmrc (repo root):

ini
Copy
Edit
store-dir=.pnpm-store
Edit package.json
â€¢ ensure "packageManager": "pnpm@10.12.1"
â€¢ under "scripts" add "preinstall": "pnpm store prune || true"
â€¢ upgrade vulnerable dep: pnpm up multer@^2 --latest

Append .pnpm-store/ to .gitignore.

============================================================
STEP 3 â€“ LOCAL SMOKE TEST
bash
Copy
Edit
set -euo pipefail
rm -rf node_modules ~/.local/share/pnpm/store
pnpm install --force
pnpm run build
node dist/server.js &   # background
sleep 3
curl -f http://localhost:5001/healthz/redis   # adjust route if different
pkill -f dist/server.js
â€¢ If any command fails â†’ STOP and print error log (do NOT commit).

============================================================
STEP 4 â€“ COMMIT & PUSH
bash
Copy
Edit
git add .replit .npmrc package.json pnpm-lock.yaml .gitignore
git commit -m "chore: stable Replit deploy (cache purge, lockfile hygiene)"
git push --set-upstream origin fix/replit-deploy
============================================================
STEP 5 â€“ CANARY DEPLOY FROM BRANCH
In Replit UI: Deploy â†’ pick branch fix/replit-deploy â†’ Deploy.

Stream build logs. Confirm the FIRST line of the build step is:
rm -rf ~/.local/share/pnpm/store && pnpm install --force && pnpm run build

Build must finish with green âœ… and server up.

============================================================
STEP 6 â€“ MERGE SAFELY
Only if Step 5 passes: open PR â†’ assign @ak â†’ wait for approval â†’ merge.
Delete branch after merge. Print â€œğŸ‰ DEPLOY PIPELINE GREENâ€ and exit.

============================================================
ERROR HANDLING
â€¢ If any step fails, print the failing command & log snippet, then pause.
â€¢ Do NOT attempt to auto-fix beyond the instructions above.
â€¢ Never push partial or failing commits.

End of runbook